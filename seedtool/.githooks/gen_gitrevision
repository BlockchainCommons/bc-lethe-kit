#!/bin/bash

## Automatically generate a file with git branch and revision info

FILENAME='seedtool/gitrevision.h'

exec 1>&2

branch=`git rev-parse --abbrev-ref HEAD`
shorthash=`git log --pretty=format:'%h' -n 1`
latesttag=`git describe --tags --abbrev=0 --always`
# revcount=`git log --oneline | wc -l`

# Compute number of revisions since last tag.
revssince=`git rev-list $latesttag..HEAD --count`
gitdescribe=`git describe --tags --long --always --match='v*.*'`

cat << EOF > $FILENAME
// ---------------- IMPORTANT - GENERATED FILE ----------------
//
// This file is generated by git hooks.
//
// Execute the following command in the seedtool directory to ensure it
// gets updated in your tree:
//
//     ./enable-gitrevision-hooks.sh
//
// See the README.md in this directory for more information ...
//

#ifndef GITREVISION_H
#define GITREVISION_H

EOF

echo "#define GIT_BRANCH \"$branch\"" >> $FILENAME
echo "#define GIT_SHORT_HASH \"$shorthash\"" >> $FILENAME
echo "#define GIT_LATEST_TAG \"$latesttag\"" >> $FILENAME
echo "#define GIT_REVS_SINCE $revssince" >> $FILENAME
echo "#define GIT_DESCRIBE \"$gitdescribe\"" >> $FILENAME

cat << EOF >> $FILENAME

#endif // GITREVISION_H
EOF
